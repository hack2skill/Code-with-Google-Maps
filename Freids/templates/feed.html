{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feed Page</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" type="text/css" href="{% static '/css/feed.css'%}"/>
    <link rel="stylesheet" type="text/css" href="{% static '/css/style.css'%}" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <body>
      <nav class="navbar navbar-dark" style="background-color: #fff2df">
          <div class="container-fluid">
            <a href="{%  url 'landing'  %}">
            <img
            src="{% static 'img/logo.jpeg' %}"
              alt="LocalVista"
              class="header-logo"
            />
    
          </a>
            <!-- Use ms-auto to move the button to the right -->
            <button
              class="navbar-toggler ms-auto"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarToggleExternalContent"
              aria-controls="navbarToggleExternalContent"
              aria-expanded="false"
              aria-label="Toggle navigation"
            >
              <!-- <i class="fas fa-user"></i> -->
              <span
                class="navbar-toggler-icon"
                style="background-color: rgb(230, 221, 221)"
              ></span>
            </button>
          </div>
        </nav>
        
        <div class="collapse" id="navbarToggleExternalContent">
              {% if user_is_authenticated %}
              <div class="bg-white p-4">
                     <a href="{% url 'profile'  %}"> <h2 class="text-black h4">Profile</h2></a>
                      <!-- <span class="text-muted">Toggleable via the navbar brand.</span> -->
                      <!-- <h2 class="text-black h4">Logout</h2> -->
                      <a href="{% url 'profile'  %}"> <h2 class="text-black h4">Logout</h2></a>
                      <a href="{% url 'feed'  %}"> <h2 class="text-black h4">Feed</h2></a>
                    </div>            
        
        {% else %}
        <div class="bg-white p-4">
              <!-- <h2 class="text-black h4">Login</h2> -->
              <a href="{% url 'login'  %}"> <h2 class="text-black h4">Login</h2></a>
              <a href="{% url 'signup'  %}"> <h2 class="text-black h4">Signup</h2></a>
              
              <!-- <span class="text-muted">Toggleable via the navbar brand.</span> -->
              <!-- <h2 class="text-black h4">Signup</h2> -->
            </div>

          {% endif %}
        </div>
        <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"
  ></script>
    <div class="collapse" id="navbarToggleExternalContent">
      <div class="bg-white p-4">
        <button class="btn btn-link" id="location-pin">
          <i class="fas fa-map-marker-alt"></i>
        </button>
        <button
          class="btn btn-link"
          id="filter-button"
          data-toggle="modal"
          data-target="#filterModal"
        >
          <i class="fas fa-sliders-h"></i>
        </button>
      </div>
    </div>
    <div class="collapse" id="navbarToggleExternalContent1">
      <div class="bg-white p-4">
        <a href="#">Profile</a>
        <br />
        <a href="#">Logout</a>
      </div>
    </div>
    <div class="container" style="background-color: #f9f8f5">
      <div class="row">
      
      </div>
    </div>
    <footer class="footer">
      &copy; 2023 LocalVista
      <div class="social-icons">
        <a href="#"><i class="fab fa-facebook"></i></a>
        <a href="#"><i class="fab fa-twitter"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
      </div>
    </footer>

    <!-- Bootstrap Modal for Filters -->
    <div
      class="modal fade"
      id="filterModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="filterModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="filterModalLabel">Set Preferences</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <form action="#" id="filter-form">
                  <div class="form-group">
                      <label for="distance">Distance (Km):</label>
                      <input
                          type="range"
                          class="form-control-range"
                          id="distance"
                          name="distance"
                          min="0"
                          max="50"  <!-- Set the max attribute to 50 for a maximum of 50 km -->
                      
                      <p id="distanceLabel">0 km</p>
                  </div>
                  <div class="form-group">
                      <label>Food Preference:</label>
                      <div class="form-check">
                          <input
                              type="radio"
                              class="form-check-input"
                              id="vegOption"
                              name="food-preference"
                              value="Veg"
                          />
                          <label class="form-check-label" for="vegOption">Veg</label>
                      </div>
                      <div class="form-check">
                          <input
                              type="radio"
                              class="form-check-input"
                              id="nonVegOption"
                              name="food-preference"
                              value="Non-Veg"
                          />
                          <label class="form-check-label" for="nonVegOption">Non-Veg</label>
                      </div>
                  </div>
                  <div class="form-group">
                      <label for="cuisine-preference">Cuisine Preference:</label>
                      <select
                          class="form-control"
                          id="cuisine-preference"
                          name="cuisine-preference"
                      >
                          <!-- Options will be dynamically populated via JavaScript -->
                      </select>
                  </div>
                  <button type="submit" class="btn btn-primary">Apply Filters</button>
              </form>
        
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    
    <script src="{% static 'js/base.js' %}"></script>
    <script>
            window.maxrange=5;
            window.cuisineNames=[]

            function get_location(){
            // Check if geolocation is available in the user's browser
            if ("geolocation" in navigator) {
                // Geolocation is available
            
                // Get the user's current position
                navigator.geolocation.getCurrentPosition(function (position) {
                // The user's latitude and longitude are available in the 'position' object
                window.latitude = position.coords.latitude;
                window.longitude = position.coords.longitude;
                update()
            
                // Now, you can use the latitude and longitude as needed, for example, display it or send it to your server.
            
                console.log("Latitude: " + window.latitude);
                console.log("Longitude: " + window.longitude);
                }, function (error) {
                // Handle any errors that occur during geolocation retrieval
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                    console.log("User denied the request for geolocation.");
                    break;
                    case error.POSITION_UNAVAILABLE:
                    console.log("Location information is unavailable.");
                    break;
                    case error.TIMEOUT:
                    console.log("The request to get user location timed out.");
                    break;
                    case error.UNKNOWN_ERROR:
                    console.log("An unknown error occurred.");
                    break;
                }
                });
            } else {
                // Geolocation is not available in the user's browser
                console.log("Geolocation is not available in this browser.");
            }
          }
            
            function update(){
                findBusinessAccounts(window.latitude, window.longitude, window.maxrange, window.cuisineNames, (error, data) => {
                  if (error) {
                        // Handle errors
                        console.error('Error:', error);
                        // Display the error message on the frontend as needed
                  } else {
                    // Handle the retrieved business accounts data
                    console.log('Business accounts within range:', data.business_accounts);
                     // Function to update HTML content based on response data
                      data_output=""
                     data.business_accounts.forEach(ev=>{
                        data_output+=`
                        <div class="col-lg-4">
                          <div class="card p-0">
                            <div class="card-image">
                              <img
                              style="width: 90vw;"
                                src=${ev.image || "https://images.pexels.com/photos/2746187/pexels-photo-2746187.jpeg?auto=compress&cs=tinysrgb&dpr=1&w=100"}
                                alt=""
                              />
                            </div>
                            <div class="card-content d-flex flex-column align-items-center">
                              <a href="/business/${ev.id}/"><h4 class="pt-2">${ev.business_name}</h4></a>
                              <h5>${ev.distance.toFixed(2)} km</h5>
                
                              <ul class="social-icons d-flex justify-content-center">
                                <li style="--i: 1">
                                  <a href="#">
                                    <span class="fab fa-facebook"></span>
                                  </a>
                                </li>
                                <li style="--i: 2">
                                  <a href="#">
                                    <span class="fab fa-twitter"></span>
                                  </a>
                                </li>
                                <li style="--i: 3">
                                  <a href="#">
                                    <span class="fab fa-instagram"></span>
                                  </a>
                                </li>
                              </ul>
                            </div>
                          </div>
                        </div>
                        
                        
                        `
                     })
                     
                     document.querySelector(".row").innerHTML=data_output
                    }})
            }

            function fetchCuisines() {
              fetch('/business/cuisines/')  // Replace with the actual URL of your API endpoint
                  .then(response => response.json())
                  .then(data => {
                      const selectElement = document.getElementById('cuisine-preference');
                      
                      data.forEach(cuisine => {
                        const option = document.createElement('option');
                        option.value = cuisine.name;
                        option.textContent = cuisine.name;
                        selectElement.appendChild(option);
                      });
                  });
          }
  
          // Fetch and display cuisines when the page loads
          fetchCuisines();

          document.addEventListener('DOMContentLoaded', function() {
            // Function to update max range and cuisine names on form submit
            
            document.getElementById('filter-form').addEventListener('submit', function (event) {
                event.preventDefault(); // Prevent the default form submission

                // Update max range from the range input
                window.maxrange = parseFloat(document.getElementById('distance').value);

                // Update cuisine names from the select element
                const cuisineSelect = document.getElementById('cuisine-preference');
                const selectedOptions = Array.from(cuisineSelect.selectedOptions);
                window.cuisineNames = selectedOptions.map(option => option.value);

                // Log the updated values for demonstration
                console.log('Max Range:', window.maxrange);
                console.log('Cuisine Names:', window.cuisineNames);
                update()
            });
        });
  


        //slider update the
        const distanceInput = document.getElementById('distance');
        const distanceLabel = document.getElementById('distanceLabel');

        // Update the label text when the slider input changes
        distanceInput.addEventListener('input', function () {
            distanceLabel.textContent = this.value + ' km';
        });
        get_location()
        document.getElementById('location-pin').onClick(ev=>{get_location(); update()})
        </script>

  </body>
</html>

